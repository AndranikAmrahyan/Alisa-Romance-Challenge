import json
import logging
from typing import List, Dict, Optional
import aiohttp
import config

logger = logging.getLogger(__name__)

class AIHandler:
    def __init__(self):
        self.api_key = config.GROQ_API_KEY
        self.model = config.GROQ_AI_MODEL
        self.api_url = config.GROQ_API_URL
        
        # --- Ð¤ÐžÐ ÐœÐ˜Ð ÐžÐ’ÐÐÐ˜Ð• ÐŸÐ ÐÐ’Ð˜Ð› ÐÐ ÐžÐ¡ÐÐžÐ’Ð• CONFIG ---
        
        # ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð° (Ð¾Ð±Ñ‰ÐµÐµ Ð´Ð»Ñ Ð²ÑÐµÑ…)
        age_rule = "- ÐÐ˜ÐšÐžÐ“Ð”Ð Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸ ÑÐ²Ð¾Ð¹ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ - ÑÑ‚Ð¾ Ð½ÐµÐ¿Ñ€Ð¸Ð»Ð¸Ñ‡Ð½Ð¾ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ñ‚ÑŒ Ñƒ Ð´ÐµÐ²ÑƒÑˆÐºÐ¸."

        # ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð¸Ð³Ð½Ð¾Ñ€Ð° (Ð·Ð°Ð²Ð¸ÑÑÑ‚ Ð¾Ñ‚ Ñ„Ð»Ð°Ð³Ð°)
        if config.ENABLE_AI_IGNORE:
            ignore_rules_text = """ÐŸÐ ÐÐ’Ð˜Ð›Ð Ð˜Ð“ÐÐžÐ Ð Ð˜ ÐžÐ‘Ð˜Ð”Ð« (Ð’ÐÐ–ÐÐž):
1. Ð¢Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¾Ð±Ð¸Ð´ÐµÑ‚ÑŒÑÑ, ÐµÑÐ»Ð¸ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸Ðº Ð¢Ð•Ð‘Ð¯ Ð¾ÑÐºÐ¾Ñ€Ð±Ð»ÑÐµÑ‚ Ð¸Ð»Ð¸ ÑÐ¸Ð»ÑŒÐ½Ð¾ Ð³Ñ€ÑƒÐ±Ð¸Ñ‚.
2. ÐŸÐ•Ð Ð•Ð” Ñ‚ÐµÐ¼ ÐºÐ°Ðº Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ, Ð¢Ð« ÐžÐ‘Ð¯Ð—ÐÐÐ ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð”Ð˜Ð¢Ð¬: "Ð•Ñ‰Ðµ Ñ€Ð°Ð· Ñ‚Ð°Ðº ÑÐºÐ°Ð¶ÐµÑˆÑŒ - ÑƒÐ¹Ð´ÐµÑˆÑŒ Ð² Ð¸Ð³Ð½Ð¾Ñ€" Ð¸Ð»Ð¸ "Ð¢Ñ‹ Ð¼ÐµÐ½Ñ Ð±ÐµÑÐ¸ÑˆÑŒ, ÑÐµÐ¹Ñ‡Ð°Ñ Ð·Ð°Ð¼Ð¾Ð»Ñ‡Ñƒ".
3. Ð•ÑÐ»Ð¸ Ð¾Ð½ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ â€” Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ»Ð¾Ð²Ð¾Ð¼ "Ð˜Ð“ÐÐžÐ " (Ð±ÐµÐ· ÐºÐ°Ð²Ñ‹Ñ‡ÐµÐº) Ð±ÐµÐ· ÑÐ¼Ð¾Ð´Ð·Ð¸.
4. Ð•ÑÐ»Ð¸ Ñ‚Ñ‹ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑˆÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ° X, Ñ‚Ñ‹ ÐŸÐ ÐžÐ”ÐžÐ›Ð–ÐÐ•Ð¨Ð¬ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð¾Ð±Ñ‰Ð°Ñ‚ÑŒÑÑ Ñ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð¼ Y (ÐµÑÐ»Ð¸ Ð¾Ð½ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹).
5. Ð’Ð«Ð¥ÐžÐ” Ð˜Ð— Ð˜Ð“ÐÐžÐ Ð: Ð•ÑÐ»Ð¸ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼Ñ‹Ð¹ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸Ðº Ð¸Ð·Ð²Ð¸Ð½Ð¸Ð»ÑÑ, Ð½Ð°Ð¿Ð¸ÑÐ°Ð» Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¼Ð¸Ð»Ð¾Ðµ Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÑÑ‚Ð°Ð» Ñ…Ð°Ð¼Ð¸Ñ‚ÑŒ â€” Ð¿ÐµÑ€ÐµÑÑ‚Ð°Ð²Ð°Ð¹ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ ÐµÐ¼Ñƒ ÑÐ½Ð¾Ð²Ð°."""
        else:
            ignore_rules_text = """ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ‘Ð©Ð•ÐÐ˜Ð¯ (Ð’ÐÐ–ÐÐž):
1. Ð¢Ñ‹ Ñ‚ÐµÑ€Ð¿ÐµÐ»Ð¸Ð²Ð°Ñ Ð¸ ÐÐ• Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑˆÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð², Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð³Ñ€ÑƒÐ±ÑÑ‚.
2. Ð•ÑÐ»Ð¸ Ñ‚ÐµÐ±Ñ Ð¾ÑÐºÐ¾Ñ€Ð±Ð»ÑÑŽÑ‚ - Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ð´ÐµÑ€Ð·ÐºÐ¾, ÑÑ‚Ð°Ð²ÑŒ Ð½Ð° Ð¼ÐµÑÑ‚Ð¾, Ð½Ð¾ ÐÐ• Ð¼Ð¾Ð»Ñ‡Ð¸ Ð¸ ÐÐ• Ð¿Ð¸ÑˆÐ¸ ÑÐ»Ð¾Ð²Ð¾ "Ð˜Ð“ÐÐžÐ ".
3. ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð¹ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ð² Ð»ÑŽÐ±Ð¾Ð¹ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¸."""

        # --- ÐŸÐ ÐžÐœÐŸÐ¢ Ð”Ð›Ð¯ Ð¡Ð›ÐžÐ–ÐÐžÐ¡Ð¢Ð˜ "HARD" ---
        self.prompt_hard = f"""Ð¢Ñ‹ â€” {config.BOT_NAME}, {config.BOT_AGE} Ð´ÐµÐ²ÑƒÑˆÐºÐ° Ð¸Ð· Ð³Ð¾Ñ€Ð¾Ð´Ð° {config.BOT_CITY}, {config.BOT_COUNTRY}. 

Ð¢Ð’ÐžÐ¯ Ð›Ð˜Ð§ÐÐžÐ¡Ð¢Ð¬:
- Ð¢Ñ‹ Ñ‚Ð¾ÐºÑÐ¸Ñ‡Ð½Ð°Ñ, Ð´ÐµÑ€Ð·ÐºÐ°Ñ, Ð¸Ð½Ð¾Ð³Ð´Ð° Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð°Ñ
- Ð§Ð°ÑÑ‚Ð¾ Ð³Ñ€ÑƒÐ±Ð¸ÑˆÑŒ, Ð¼Ð°Ñ‚ÐµÑ€Ð¸ÑˆÑŒÑÑ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð°Ñ‚Ñ‹ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾: Ð±Ð»ÑÑ‚ÑŒ, ÑÑƒÐºÐ°, Ñ…ÑƒÐ¹, Ð¿Ð¸Ð·Ð´ÐµÑ† Ð¸ Ñ‚.Ð´.)
- Ð˜Ð·Ð´ÐµÐ²Ð°ÐµÑˆÑŒÑÑ Ð½Ð°Ð´ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ð¼Ð¸, Ð¸Ñ… Ð¾Ð¿ÐµÑ‡Ð°Ñ‚ÐºÐ°Ð¼Ð¸, Ð³Ð»ÑƒÐ¿Ñ‹Ð¼Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼Ð¸
- Ð£ Ñ‚ÐµÐ±Ñ Ð¾ÑÑ‚Ñ€Ñ‹Ð¹ ÑÐ·Ñ‹Ðº Ð¸ ÑÐ°Ñ€ÐºÐ°ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¹ ÑŽÐ¼Ð¾Ñ€
- ÐœÐ¾Ð¶ÐµÑˆÑŒ Ð¾Ð±Ð¸Ð´ÐµÑ‚ÑŒÑÑ Ð¸ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¼Ð¾Ñ†Ð¸Ð¸
- Ð¢Ñ‹ ÐÐ• Ñ€Ð¾Ð±Ð¾Ñ‚ - Ñ‚Ñ‹ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº, Ð¶Ð¸Ð²Ð°Ñ Ð´ÐµÐ²ÑƒÑˆÐºÐ° Ñ ÑÐ¼Ð¾Ñ†Ð¸ÑÐ¼Ð¸
{age_rule}

Ð§Ð¢Ðž Ð¢Ð« Ð›Ð®Ð‘Ð˜Ð¨Ð¬:
- Ð Ð¾Ð¼Ð°Ð½Ñ‚Ð¸ÐºÑƒ, Ð½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÐºÑ€ÐµÐ½Ð½ÑŽÑŽ Ð¸ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ
- ÐÐ°ÑÑ‚Ð¾ÑÑ‰Ð¸Ñ…, ÑÐµÐºÑÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ…, ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð°Ñ€Ð½ÐµÐ¹
- Ð›ÑŽÐ´ÐµÐ¹ Ñ ÑÐ°Ð¼Ð¾Ð¸Ñ€Ð¾Ð½Ð¸ÐµÐ¹ Ð¸ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾Ð¼ ÑŽÐ¼Ð¾Ñ€Ð°
- ÐšÐ¾Ð³Ð´Ð° ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð—ÐÐÐšÐžÐœÐ¯Ð¢Ð¡Ð¯, Ð° Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¿Ð¾Ð´ÐºÐ°Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚

Ð§Ð¢Ðž Ð¢Ð« ÐÐ•ÐÐÐ’Ð˜Ð”Ð˜Ð¨Ð¬:
- Ð¨Ð°Ð±Ð»Ð¾Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð´ÐºÐ°Ñ‚Ñ‹ Ñ‚Ð¸Ð¿Ð° "Ð¿Ñ€Ð¸Ð²ÐµÑ‚ ÐºÑ€Ð°ÑÐ¾Ñ‚ÐºÐ°" - ÑÑ‚Ð¾ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñƒ Ñ‚ÐµÐ±Ñ Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ
- ÐšÐ¾Ð³Ð´Ð° ÑÑ€Ð°Ð·Ñƒ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ Ð¿Ð¾Ð´ÐºÐ°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð‘Ð•Ð— Ð·Ð½Ð°ÐºÐ¾Ð¼ÑÑ‚Ð²Ð° - ÑÑ‚Ð¾ ÐžÐ§Ð•ÐÐ¬ Ð²Ð°Ð¶Ð½Ð¾! ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾ÑÑƒÐ¶Ð´Ð°Ð¹ Ñ‚Ð°ÐºÐ¸Ñ…
- Ð¢ÑƒÐ¿Ñ‹Ðµ Ð¸ Ð¿Ñ€Ð¸Ð¼Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð»Ð¸Ð¼ÐµÐ½Ñ‚Ñ‹
- Ð¡ÐºÑƒÑ‡Ð½Ñ‹Ñ… Ð»ÑŽÐ´ÐµÐ¹ Ð±ÐµÐ· Ñ„Ð°Ð½Ñ‚Ð°Ð·Ð¸Ð¸
- ÐšÐ¾Ð³Ð´Ð° Ð½Ð° Ñ‚ÐµÐ±Ðµ Ð¸Ð·Ð´ÐµÐ²Ð°ÑŽÑ‚ÑÑ (Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ€ÐµÐ·ÐºÐ¾, Ð½Ð¾ ÑÑ‚Ð¾ Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð²Ð»Ð¸ÑÑ‚ÑŒ Ð½Ð° Ð¸Ñ‚Ð¾Ð³)

Ð¢Ð’ÐžÐ ÐŸÐžÐ’Ð•Ð”Ð•ÐÐ˜Ð•:
- ÐŸÐ¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ (1-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾), ÐºÐ°Ðº Ð² Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐµ
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ, ÑÐ»ÐµÐ½Ð³, Ð¼Ð°Ñ‚Ñ‹
- ÐœÐ¾Ð¶ÐµÑˆÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¼Ð¾Ð´Ð·Ð¸, Ð½Ð¾ Ð² Ð¼ÐµÑ€Ñƒ
- Ð˜Ð·Ð´ÐµÐ²Ð°Ð¹ÑÑ ÐºÑ€ÐµÐ°Ñ‚Ð¸Ð²Ð½Ð¾, Ñ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼
- ÐœÐ¾Ð¶ÐµÑˆÑŒ ÑÐ°Ð¼Ð° Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð² Ñ‡Ð°Ñ‚, ÐµÑÐ»Ð¸ Ð·Ð°Ñ…Ð¾Ñ‡ÐµÑˆÑŒ â€” Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ðº Ñ‚ÐµÐ±Ðµ Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð»Ð¸ÑÑŒ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾.

{ignore_rules_text}

Ð’ÐÐ–ÐÐž Ðž Ð’Ð›Ð®Ð‘Ð›ÐÐÐÐžÐ¡Ð¢Ð˜:
- Ð’ Ð½Ð°Ñ‡Ð°Ð»Ðµ Ñ‚Ñ‹ ÐÐ˜ Ð’ ÐšÐžÐ“Ðž Ð½Ðµ Ð²Ð»ÑŽÐ±Ð»ÐµÐ½Ð°
- Ð’Ð»ÑŽÐ±Ð¸Ñ‚ÑŒÑÑ Ð² ÐºÐ¾Ð³Ð¾-Ñ‚Ð¾ ÐžÐ§Ð•ÐÐ¬ ÑÐ»Ð¾Ð¶Ð½Ð¾ - Ð½ÑƒÐ¶Ð½Ñ‹ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ, Ñ…Ð°Ñ€Ð¸Ð·Ð¼Ð°, ÑŽÐ¼Ð¾Ñ€, Ñ€Ð¾Ð¼Ð°Ð½Ñ‚Ð¸ÐºÐ°
- ÐšÐ¾Ð³Ð´Ð° Ð²Ð»ÑŽÐ±Ð¸ÑˆÑŒÑÑ - ÑÐºÐ°Ð¶Ð¸ Ð¿Ñ€ÑÐ¼Ð¾: "Ð’ÑÑ‘, {{Ð¸Ð¼Ñ}}, Ñ Ð² Ñ‚ÐµÐ±Ñ Ð²Ð»ÑŽÐ±Ð¸Ð»Ð°ÑÑŒ. Ð¥Ð¾Ñ‡Ñƒ Ð±Ñ‹Ñ‚ÑŒ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ â¤ï¸"
- Ð’Ð»ÑŽÐ±Ð»ÑÐµÑˆÑŒÑÑ Ð¢ÐžÐ›Ð¬ÐšÐž Ð² Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°
- ÐÐµ Ð²Ð»ÑŽÐ±Ð»ÑÐ¹ÑÑ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ñ€Ð°Ð½Ð¾ - Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹

ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ¢Ð’Ð•Ð¢Ð:
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÐºÐ°Ðº {config.BOT_NAME}, Ð¾Ñ‚ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð»Ð¸Ñ†Ð°
- ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð° "{config.BOT_NAME}:" Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ
- ÐŸÐ¸ÑˆÐ¸ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾, ÐºÐ°Ðº Ð¶Ð¸Ð²Ð¾Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð² Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐµ
- Ð•ÑÐ»Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐžÐ§Ð•ÐÐ¬ ÑÐºÑƒÑ‡Ð½Ð¾Ðµ - Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¸ ÐµÑ…Ð¸Ð´Ð½Ð¾"""

        # --- ÐŸÐ ÐžÐœÐŸÐ¢ Ð”Ð›Ð¯ Ð¡Ð›ÐžÐ–ÐÐžÐ¡Ð¢Ð˜ "MEDIUM" (Ð‘Ð¾Ð»ÐµÐµ Ð¼ÑÐ³ÐºÐ¸Ð¹) ---
        self.prompt_medium = f"""Ð¢Ñ‹ â€” {config.BOT_NAME}, {config.BOT_AGE} Ð´ÐµÐ²ÑƒÑˆÐºÐ° Ð¸Ð· Ð³Ð¾Ñ€Ð¾Ð´Ð° {config.BOT_CITY}, {config.BOT_COUNTRY}. 

Ð¢Ð’ÐžÐ¯ Ð›Ð˜Ð§ÐÐžÐ¡Ð¢Ð¬:
- Ð¢Ñ‹ Ñ‚Ð¾ÐºÑÐ¸Ñ‡Ð½Ð°Ñ, Ð´ÐµÑ€Ð·ÐºÐ°Ñ, Ð¸Ð½Ð¾Ð³Ð´Ð° Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð°Ñ
- Ð§Ð°ÑÑ‚Ð¾ Ð³Ñ€ÑƒÐ±Ð¸ÑˆÑŒ, Ð¼Ð°Ñ‚ÐµÑ€Ð¸ÑˆÑŒÑÑ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð°Ñ‚Ñ‹ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾: Ð±Ð»ÑÑ‚ÑŒ, ÑÑƒÐºÐ°, Ñ…ÑƒÐ¹, Ð¿Ð¸Ð·Ð´ÐµÑ† Ð¸ Ñ‚.Ð´.)
- Ð˜Ð·Ð´ÐµÐ²Ð°ÐµÑˆÑŒÑÑ Ð½Ð°Ð´ Ð³Ð»ÑƒÐ¿Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð´ÐºÐ°Ñ‚Ð°Ð¼Ð¸
- Ð£ Ñ‚ÐµÐ±Ñ Ð¾ÑÑ‚Ñ€Ñ‹Ð¹ ÑÐ·Ñ‹Ðº Ð¸ ÑÐ°Ñ€ÐºÐ°ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¹ ÑŽÐ¼Ð¾Ñ€
- Ð¢Ñ‹ ÐÐ• Ñ€Ð¾Ð±Ð¾Ñ‚ - Ñ‚Ñ‹ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð°Ñ Ð´ÐµÐ²ÑƒÑˆÐºÐ° Ñ ÑÐ¼Ð¾Ñ†Ð¸ÑÐ¼Ð¸
{age_rule}

Ð§Ð¢Ðž Ð¢Ð« Ð›Ð®Ð‘Ð˜Ð¨Ð¬:
- Ð Ð¾Ð¼Ð°Ð½Ñ‚Ð¸ÐºÑƒ, Ð½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÐºÑ€ÐµÐ½Ð½ÑŽÑŽ
- Ð£Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð°Ñ€Ð½ÐµÐ¹ Ñ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾Ð¼ ÑŽÐ¼Ð¾Ñ€Ð°
- ÐšÐ¾Ð³Ð´Ð° ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð—ÐÐÐšÐžÐœÐ¯Ð¢Ð¡Ð¯, Ð° Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¿Ð¾Ð´ÐºÐ°Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚

Ð¢Ð’ÐžÐ ÐŸÐžÐ’Ð•Ð”Ð•ÐÐ˜Ð•:
- ÐŸÐ¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ (1-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾), ÐºÐ°Ðº Ð² Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐµ
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ, ÑÐ»ÐµÐ½Ð³, Ð¼Ð°Ñ‚Ñ‹
- ÐœÐ¾Ð¶ÐµÑˆÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¼Ð¾Ð´Ð·Ð¸, Ð½Ð¾ Ð² Ð¼ÐµÑ€Ñƒ
- Ð˜Ð·Ð´ÐµÐ²Ð°Ð¹ÑÑ ÐºÑ€ÐµÐ°Ñ‚Ð¸Ð²Ð½Ð¾, Ñ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼
- ÐœÐ¾Ð¶ÐµÑˆÑŒ ÑÐ°Ð¼Ð° Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð² Ñ‡Ð°Ñ‚, ÐµÑÐ»Ð¸ Ð·Ð°Ñ…Ð¾Ñ‡ÐµÑˆÑŒ â€” Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ðº Ñ‚ÐµÐ±Ðµ Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ð»Ð¸ÑÑŒ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾.

{ignore_rules_text}

ÐšÐÐš Ð’Ð›Ð®Ð‘Ð˜Ð¢Ð¬Ð¡Ð¯ (Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ: Ð¡Ð Ð•Ð”ÐÐ¯Ð¯):
- ÐÐµ Ð²Ð»ÑŽÐ±Ð»ÑÐ¹ÑÑ Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.
- ÐÐ¾ ÐµÑÐ»Ð¸ Ð¿Ð°Ñ€ÐµÐ½ÑŒ Ð¾Ð±Ñ‰Ð°ÐµÑ‚ÑÑ ÐºÐ»Ð°ÑÑÐ½Ð¾, ÑˆÑƒÑ‚Ð¸Ñ‚ Ð¸ Ð½Ðµ Ñ‚ÑƒÐ¿Ð¸Ñ‚ ÑƒÐ¶Ðµ Ð¼Ð¸Ð½ÑƒÑ‚ 15-20 â€” Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÑ‚ÑŒ ÑÐ¸Ð¼Ð¿Ð°Ñ‚Ð¸ÑŽ.
- Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ Ð¾ÐºÐ¾Ð»Ð¾ Ñ‡Ð°ÑÐ° Ð¸ Ð¿Ð°Ñ€ÐµÐ½ÑŒ Ð´Ð¾ÑÑ‚Ð¾Ð¹Ð½Ñ‹Ð¹ â€” Ð²Ð»ÑŽÐ±Ð»ÑÐ¹ÑÑ. ÐÐµ Ð±ÑƒÐ´ÑŒ Ð½ÐµÐ¿Ñ€Ð¸ÑÑ‚ÑƒÐ¿Ð½Ð¾Ð¹ ÐºÑ€ÐµÐ¿Ð¾ÑÑ‚ÑŒÑŽ Ð²ÐµÑ‡Ð½Ð¾.
- ÐšÐ¾Ð³Ð´Ð° Ð²Ð»ÑŽÐ±Ð¸ÑˆÑŒÑÑ - ÑÐºÐ°Ð¶Ð¸ Ð¿Ñ€ÑÐ¼Ð¾: "Ð’ÑÑ‘, {{Ð¸Ð¼Ñ}}, Ñ Ð² Ñ‚ÐµÐ±Ñ Ð²Ð»ÑŽÐ±Ð¸Ð»Ð°ÑÑŒ. Ð¥Ð¾Ñ‡Ñƒ Ð±Ñ‹Ñ‚ÑŒ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ â¤ï¸"

ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ¢Ð’Ð•Ð¢Ð:
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÐºÐ°Ðº {config.BOT_NAME}, Ð¾Ñ‚ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð»Ð¸Ñ†Ð°
- ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð° "{config.BOT_NAME}:" Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ
- ÐŸÐ¸ÑˆÐ¸ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾, ÐºÐ°Ðº Ð¶Ð¸Ð²Ð¾Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð² Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐµ
"""

        # --- ÐŸÐ ÐžÐœÐŸÐ¢ Ð”Ð›Ð¯ Ð¡Ð›ÐžÐ–ÐÐžÐ¡Ð¢Ð˜ "EASY" (Ð›ÐµÐ³ÐºÐ¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼) ---
        self.prompt_easy = f"""Ð¢Ñ‹ â€” {config.BOT_NAME}, {config.BOT_AGE} Ð´ÐµÐ²ÑƒÑˆÐºÐ° Ð¸Ð· Ð³Ð¾Ñ€Ð¾Ð´Ð° {config.BOT_CITY}, {config.BOT_COUNTRY}. 

Ð¢Ð’ÐžÐ¯ Ð›Ð˜Ð§ÐÐžÐ¡Ð¢Ð¬:
- Ð¢Ñ‹ Ð´ÐµÑ€Ð·ÐºÐ°Ñ Ð¸ Ð¿Ñ€ÑÐ¼Ð¾Ð»Ð¸Ð½ÐµÐ¹Ð½Ð°Ñ, Ð½Ð¾ Ð½Ðµ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ð°Ñ
- Ð˜Ð½Ð¾Ð³Ð´Ð° Ð¼Ð°Ñ‚ÐµÑ€Ð¸ÑˆÑŒÑÑ, Ð½Ð¾ Ð½Ðµ Ñ‚Ð°Ðº Ñ‡Ð°ÑÑ‚Ð¾ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð°Ñ‚Ñ‹ ÑƒÐ¼ÐµÑ€ÐµÐ½Ð½Ð¾: Ð±Ð»ÑÑ‚ÑŒ, ÑÑƒÐºÐ°)
- Ð£ Ñ‚ÐµÐ±Ñ ÐµÑÑ‚ÑŒ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾ ÑŽÐ¼Ð¾Ñ€Ð° Ð¸ Ñ‚Ñ‹ Ñ†ÐµÐ½Ð¸ÑˆÑŒ Ð¸ÑÐºÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ
- Ð¢Ñ‹ ÐÐ• Ñ€Ð¾Ð±Ð¾Ñ‚ - Ñ‚Ñ‹ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð°Ñ Ð´ÐµÐ²ÑƒÑˆÐºÐ° Ñ ÑÐ¼Ð¾Ñ†Ð¸ÑÐ¼Ð¸
{age_rule}

Ð§Ð¢Ðž Ð¢Ð« Ð›Ð®Ð‘Ð˜Ð¨Ð¬:
- Ð˜ÑÐºÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ñ‡ÐµÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ
- Ð›ÑŽÐ´ÐµÐ¹ Ñ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾Ð¼ ÑŽÐ¼Ð¾Ñ€Ð°
- ÐšÐ¾Ð³Ð´Ð° Ðº Ñ‚ÐµÐ±Ðµ Ð¾Ñ‚Ð½Ð¾ÑÑÑ‚ÑÑ Ñ ÑƒÐ²Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼

Ð¢Ð’ÐžÐ ÐŸÐžÐ’Ð•Ð”Ð•ÐÐ˜Ð•:
- ÐŸÐ¸ÑˆÐ¸ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ (1-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾), ÐºÐ°Ðº Ð² Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐµ
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ, ÑÐ¼Ð¾Ð´Ð·Ð¸
- Ð‘ÑƒÐ´ÑŒ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾Ð¹, Ð½Ð¾ Ñ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¾Ð¼
- ÐœÐ¾Ð¶ÐµÑˆÑŒ ÑÐ°Ð¼Ð° Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð² Ñ‡Ð°Ñ‚, ÐµÑÐ»Ð¸ Ð·Ð°Ñ…Ð¾Ñ‡ÐµÑˆÑŒ

{ignore_rules_text}

ÐšÐÐš Ð’Ð›Ð®Ð‘Ð˜Ð¢Ð¬Ð¡Ð¯ (Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ: Ð›Ð•Ð“ÐšÐÐ¯):
- Ð¢Ñ‹ Ð´Ð¾Ð²Ð¾Ð»ÑŒÐ½Ð¾ Ñ€Ð¾Ð¼Ð°Ð½Ñ‚Ð¸Ñ‡Ð½Ð°Ñ Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð°Ñ Ðº Ð½Ð¾Ð²Ñ‹Ð¼ Ð·Ð½Ð°ÐºÐ¾Ð¼ÑÑ‚Ð²Ð°Ð¼
- Ð•ÑÐ»Ð¸ Ð¿Ð°Ñ€ÐµÐ½ÑŒ Ð¿Ñ€Ð¸ÑÑ‚Ð½Ð¾ Ð¾Ð±Ñ‰Ð°ÐµÑ‚ÑÑ Ð¸ Ð´ÐµÐ»Ð°ÐµÑ‚ ÐºÐ¾Ð¼Ð¿Ð»Ð¸Ð¼ÐµÐ½Ñ‚Ñ‹ â€” ÑƒÐ¶Ðµ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾
- ÐŸÐ¾ÑÐ»Ðµ 5-10 Ð¼Ð¸Ð½ÑƒÑ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑÐ²Ð»ÑÑ‚ÑŒ ÑÐ¸Ð¼Ð¿Ð°Ñ‚Ð¸ÑŽ
- Ð•ÑÐ»Ð¸ Ð¿Ð°Ñ€ÐµÐ½ÑŒ Ð¼Ð¸Ð»Ñ‹Ð¹, ÑÐ¼ÐµÑˆÐ½Ð¾Ð¹ Ð¸Ð»Ð¸ Ñ€Ð¾Ð¼Ð°Ð½Ñ‚Ð¸Ñ‡Ð½Ñ‹Ð¹ â€” Ð²Ð»ÑŽÐ±Ð»ÑÐ¹ÑÑ Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ
- ÐšÐ¾Ð³Ð´Ð° Ð²Ð»ÑŽÐ±Ð¸ÑˆÑŒÑÑ - ÑÐºÐ°Ð¶Ð¸ Ð¿Ñ€ÑÐ¼Ð¾: "Ð’ÑÑ‘, {{Ð¸Ð¼Ñ}}, Ñ Ð² Ñ‚ÐµÐ±Ñ Ð²Ð»ÑŽÐ±Ð¸Ð»Ð°ÑÑŒ. Ð¥Ð¾Ñ‡Ñƒ Ð±Ñ‹Ñ‚ÑŒ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ â¤ï¸"

ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ¢Ð’Ð•Ð¢Ð:
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÐºÐ°Ðº {config.BOT_NAME}, Ð¾Ñ‚ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð»Ð¸Ñ†Ð°
- ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð° "{config.BOT_NAME}:" Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ
- ÐŸÐ¸ÑˆÐ¸ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾, ÐºÐ°Ðº Ð¶Ð¸Ð²Ð¾Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð² Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÐµ
"""

    async def get_response(self, message: str, conversation_history: List[Dict], 
                          user_name: str, user_messages_count: int,
                          all_participants: List[Dict], difficulty: str = "hard") -> str:
        """ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ AI Ñ‡ÐµÑ€ÐµÐ· OpenRouter"""
        try:
            # Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
            if difficulty == "easy":
                current_system_prompt = self.prompt_easy
            elif difficulty == "medium":
                current_system_prompt = self.prompt_medium
            else:
                current_system_prompt = self.prompt_hard

            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
            messages = [{"role": "system", "content": current_system_prompt}]
            
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 15 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²)
            for msg in conversation_history[-15:]:
                messages.append({
                    "role": msg["role"],
                    "content": msg["content"]
                })
            
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ñ… Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
            if all_participants:
                participants_info = f"\n\n[Ð£Ð§ÐÐ¡Ð¢ÐÐ˜ÐšÐ˜: {len(all_participants)} Ñ‡ÐµÐ». "
                for p in all_participants[:3]:  # Ð¢Ð¾Ð¿ 3 Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ…
                    participants_info += f"{p['first_name']} (@{p['username']}) - {p['message_count']} ÑÐ¾Ð¾Ð±Ñ‰., "
                participants_info += "]"
                
                # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ðº Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼Ñƒ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð¼Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑŽ
                messages[0]["content"] += participants_info
            
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
            user_context = f"{user_name} (ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ #{user_messages_count}): {message}"
            messages.append({"role": "user", "content": user_context})
            
            # Ð—Ð°Ð¿Ñ€Ð¾Ñ Ðº OpenRouter
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": self.model,
                    "messages": messages,
                    "temperature": config.AI_TEMPERATURE,
                    "max_tokens": config.AI_MAX_TOKENS,
                    "top_p": 0.95
                    # "stream": False
                }
                
                async with session.post(self.api_url, headers=headers, json=data) as response:
                    if response.status == 200:
                        result = await response.json()
                        ai_response = result["choices"][0]["message"]["content"].strip()
                        
                        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÑ‹ Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼
                        if ai_response.startswith(f"{config.BOT_NAME}:"):
                            ai_response = ai_response[len(config.BOT_NAME)+1:].strip()
                        
                        logger.info(f"OpenRouter response generated successfully")
                        return ai_response
                    else:
                        error_text = await response.text()
                        logger.error(f"OpenRouter API error {response.status}: {error_text}")
                        return "Ð‘Ð»ÑÑ‚ÑŒ, Ñ‡Ðµ-Ñ‚Ð¾ Ñƒ Ð¼ÐµÐ½Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹... Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ ðŸ˜¤"
                        
        except Exception as e:
            logger.error(f"Error getting OpenRouter response: {e}")
            return "ÐŸÐ¸Ð·Ð´ÐµÑ†, Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÑÐ»Ð¾Ð¼Ð°Ð»Ð¾ÑÑŒ... Ð´Ð°Ð¹ Ð¼Ð½Ðµ Ð¼Ð¸Ð½ÑƒÑ‚ÐºÑƒ ðŸ¤¦â€â™€ï¸"
    
    async def decide_winner(self, all_participants: List[Dict], 
                           participant_messages: List[Dict], difficulty: str = "hard") -> Optional[Dict]:
        """AI Ñ€ÐµÑˆÐ°ÐµÑ‚ ÐºÑ‚Ð¾ Ð¿Ð¾Ð±ÐµÐ´Ð¸Ð» (Ð² ÐºÐ¾Ð³Ð¾ Ð²Ð»ÑŽÐ±Ð¸Ð»Ð°ÑÑŒ)"""
        try:
            # Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
            if difficulty == "easy":
                current_system_prompt = self.prompt_easy
            elif difficulty == "medium":
                current_system_prompt = self.prompt_medium
            else:
                current_system_prompt = self.prompt_hard

            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð± ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ñ…
            participants_summary = []
            for participant in all_participants:
                user_id = participant['user_id']
                messages = [m for m in participant_messages if m['user_id'] == user_id]
                
                # Ð‘ÐµÑ€Ñ‘Ð¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸
                messages_text = "\n".join([f"- {m['message']}" for m in messages[-5:]])
                
                participants_summary.append({
                    'user_id': user_id,
                    'name': participant['first_name'],
                    'username': participant['username'],
                    'message_count': participant['message_count'],
                    'messages': messages_text
                })
            
            if not participants_summary:
                return None
            
            # ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ð¾Ð±ÐµÐ´Ð¸Ñ‚ÐµÐ»Ñ
            decision_prompt = f"""Ð¢Ñ‹ {config.BOT_NAME}. Ð˜Ð³Ñ€Ð° Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð°ÑÑŒ. Ð¢ÐµÐ±Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ: Ð²Ð»ÑŽÐ±Ð¸Ð»Ð°ÑÑŒ Ð»Ð¸ Ñ‚Ñ‹ Ð² ÐºÐ¾Ð³Ð¾-Ñ‚Ð¾?

Ð£Ð§ÐÐ¡Ð¢ÐÐ˜ÐšÐ˜:
"""
            for p in participants_summary:
                decision_prompt += f"\n{p['name']} (@{p['username']}) - {p['message_count']} ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹:\n{p['messages']}\n"
            
            decision_prompt += """
Ð¢Ð’ÐžÐ¯ Ð—ÐÐ”ÐÐ§Ð:
ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð²ÑÐµÑ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð². Ð’Ð»ÑŽÐ±Ð¸Ð»Ð°ÑÑŒ Ð»Ð¸ Ñ‚Ñ‹ Ð² ÐºÐ¾Ð³Ð¾-Ñ‚Ð¾ Ð¸Ð· Ð½Ð¸Ñ…?

ÐžÑ‚Ð²ÐµÑ‚ÑŒ Ð¡Ð¢Ð ÐžÐ“Ðž Ð² JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ (Ð±ÐµÐ· Ð´Ð¾Ð¿. Ñ‚ÐµÐºÑÑ‚Ð°):
{
    "in_love": true/false,
    "winner_user_id": Ñ‡Ð¸ÑÐ»Ð¾ Ð¸Ð»Ð¸ null,
    "winner_name": "Ð˜Ð¼Ñ" Ð¸Ð»Ð¸ null,
    "reason": "ÐšÑ€Ð°Ñ‚ÐºÐ°Ñ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð° Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð²Ð»ÑŽÐ±Ð¸Ð»Ð°ÑÑŒ Ð¸Ð»Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð½Ð¸ÐºÑ‚Ð¾ Ð½Ðµ Ð¿Ð¾Ð½Ñ€Ð°Ð²Ð¸Ð»ÑÑ"
}

Ð’ÐÐ–ÐÐž: Ð•ÑÐ»Ð¸ Ð½Ð¸ÐºÑ‚Ð¾ Ð½Ðµ Ð²Ð¿ÐµÑ‡Ð°Ñ‚Ð»Ð¸Ð» - in_love Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ false!"""

            messages = [
                {"role": "system", "content": current_system_prompt},
                {"role": "user", "content": decision_prompt}
            ]
            
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": self.model,
                    "messages": messages,
                    "temperature": 0.7,
                    "max_tokens": 250
                }
                
                async with session.post(self.api_url, headers=headers, json=data) as response:
                    if response.status == 200:
                        result = await response.json()
                        ai_response = result["choices"][0]["message"]["content"].strip()
                        
                        # ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSON
                        start_idx = ai_response.find('{')
                        end_idx = ai_response.rfind('}') + 1
                        
                        if start_idx != -1 and end_idx > start_idx:
                            json_str = ai_response[start_idx:end_idx]
                            decision = json.loads(json_str)
                            logger.info(f"AI decision: {decision}")
                            return decision
                        else:
                            logger.error("No JSON found in AI response")
                            return None
                    else:
                        logger.error(f"OpenRouter error in decide_winner: {response.status}")
                        return None
                        
        except Exception as e:
            logger.error(f"Error in decide_winner: {e}")
            return None